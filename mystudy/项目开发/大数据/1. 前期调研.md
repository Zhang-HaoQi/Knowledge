# Oj项目

大全：https://blog.csdn.net/weixin_30432007/article/details/99341701?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522165491018516780357239364%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=165491018516780357239364&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-2-99341701-null-null.142^v13^pc_search_result_control_group,157^v14^control&utm_term=oj%E6%B5%8B%E8%AF%84%E7%B3%BB%E7%BB%9F&spm=1018.2226.3001.4187

参考：[(138条消息) 基于Java开发的在线OJ项目_:-D:）的博客-CSDN博客_在线oj系统java实现](https://blog.csdn.net/weixin_44780625/article/details/109264232)

OJ中提交Java程序的一些套路：[(138条消息) OJ中提交Java程序的一些套路_bat67的博客-CSDN博客](https://blog.csdn.net/bat67/article/details/79685997)

qingdaooj：[OnlineJudge – 每天进步一点点 (longkui.site)](https://www.longkui.site/onlinejudge/)

# K8s

详解：https://baijiahao.baidu.com/s?id=1721040222341192801&wfr=spider&for=pc

学习：https://blog.csdn.net/qq_28903377/category_11764402.html

部署：[mystudy/服务器部署/虚拟机相关操作.md · Zhang-HaoQi/Knowledge - 码云 - 开源中国 (gitee.com)](https://gitee.com/zhang-haoqi/knowledge/blob/develop/mystudy/服务器部署/虚拟机相关操作.md)

[(134条消息) 【K8S】基于单Master节点安装K8S集群_冰 河的博客-CSDN博客](https://binghe.blog.csdn.net/article/details/105898051)

[【K8S】 基于Kubernetes部署Kafka集群_冰 河的博客-CSDN博客_kafka kubernetes](https://binghe.blog.csdn.net/article/details/106773932)

k8s部署springboot应用：

1. https://blog.csdn.net/m0_37063785/article/details/101303898?spm=1001.2101.3001.6650.5&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7ERate-5-101303898-blog-121154981.pc_relevant_paycolumn_v3&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7ERate-5-101303898-blog-121154981.pc_relevant_paycolumn_v3&utm_relevant_index=10
2. https://dalin.blog.csdn.net/article/details/121154981?spm=1001.2101.3001.6650.3&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-3-121154981-blog-121646340.pc_relevant_default&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-3-121154981-blog-121646340.pc_relevant_default&utm_relevant_index=6



1. 

待调研内容：

1. java操作k8s

   1. java操作k8s-api接口创建容器

      https://blog.csdn.net/yrbwxt/article/details/112708918

   2. https://blog.csdn.net/dfBeautifulLive/article/details/102874791

   3. [(139条消息) Kubernetes client-java方式创建命名空间,创建pod容器，创建serice服务等功能_渣渣洒泪成长记的博客-CSDN博客](https://blog.csdn.net/dfBeautifulLive/article/details/103084362)

   4. java通过yml操作k8shttps://blog.csdn.net/zhangxue_wei/article/details/108469921

2. 在已有的pod节点上创建docker容器

   1. 

3. 监控pod中结点的运行状态

4. pod的管理[(139条消息) K8S之ReplicaSet详解_Jeremy_Lee123的博客-CSDN博客_k8s replicaset](https://blog.csdn.net/lixinkuan328/article/details/103992861)

   1. https://blog.csdn.net/u014203449/article/details/110917661
   2. https://blog.csdn.net/zhangxue_wei/article/details/108469921
   3. https://blog.csdn.net/linjingyg/article/details/121295156?spm=1001.2101.3001.6650.1&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-1-121295156-blog-124575235.pc_relevant_blogantidownloadv1&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-1-121295156-blog-124575235.pc_relevant_blogantidownloadv1&utm_relevant_index=1
   4. https://blog.csdn.net/qq_28903377/article/details/124575235
   5. https://liruilong.blog.csdn.net/article/details/122020019?spm=1001.2101.3001.6661.1&utm_medium=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-1-122020019-blog-125232827.pc_relevant_downloadblacklistv1&depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-1-122020019-blog-125232827.pc_relevant_downloadblacklistv1&utm_relevant_index=1

5. 如何将pod和dockerfile联系在一起

   1. https://www.kancloud.cn/panxin20/notes/1923534
   2. 

docker compose

https://blog.csdn.net/qq_28903377/article/details/124164803

https://blog.csdn.net/I_am_fine_/article/details/124549852

https://blog.csdn.net/qq_28903377/category_8518983.html



如何在docker容器中编译运行Java代码

https://www.jianshu.com/p/9f88abed57a9/



[.NET CORE IN DOCKER 在容器内编译并发布 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/115846919)



springboot操作k8s

https://www.freesion.com/article/8890171785/





k8s的pod

https://www.xujun.org/note-134402.html



好文：

https://blog.csdn.net/sanhewuyang/category_11490195.html





# 核心步骤

## 编译代码

pod创建时，执行代码执行，类似于docker命令：`docker run --rm  -v /file/code/java:/file/code/java dquintela/openjdk-8-jdk-alpine /bin/sh -c cd /file/code/java&&javac HelloWorld.java&&java HelloWorld`

策略：

用户上传到宿主机的代码，同步到容器中，创建pod时执行代码编译，将结果输入到文件夹。

```java
package com.example.mydemo.controller;

import com.alibaba.fastjson.JSONObject;
import io.kubernetes.client.ApiClient;
import io.kubernetes.client.ApiException;
import io.kubernetes.client.Configuration;
import io.kubernetes.client.apis.AppsV1Api;
import io.kubernetes.client.apis.CoreV1Api;
import io.kubernetes.client.custom.IntOrString;
import io.kubernetes.client.models.*;
import io.kubernetes.client.util.ClientBuilder;
import io.kubernetes.client.util.KubeConfig;
import io.swagger.annotations.Api;
import lombok.extern.slf4j.Slf4j;
import org.springframework.util.ResourceUtils;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.io.*;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * @Classname K8sTestController
 * @Description TODO
 * @Date 2022/6/11 10:56
 * @Created by zhq
 */
@Api("控制器管理")
@RestController
@RequestMapping("k8s")
@Slf4j
public class K8sTestController {


    public static void main(String[] args) throws IOException, ApiException {

        String kubeConfigPath = "classpath:config";
//        Reader rd =new FileReader(kubeConfigPath);
        //加载k8s,config
        ApiClient client =
                ClientBuilder.kubeconfig(KubeConfig.loadKubeConfig( new FileReader(ResourceUtils.getFile(kubeConfigPath)))).build();

        //将加载config的client设置为默认的client
        Configuration.setDefaultApiClient(client);

        //创建一个api
        CoreV1Api api = new CoreV1Api(client);


        //创建空间
//        createNamespace(api);

        AppsV1Api apiInstance = new AppsV1Api(client);
        //发布应用
        createDeployment(apiInstance,"compile-test");

        //创建service
//        createService(api,"default");

        //服务升级
//        applyDeployment(apiInstance,"default");
        //拷贝文件
//        copyFile(api,"default");

    }


//    public static void copyFile(CoreV1Api api,String namespace) throws IOException, ApiException {
//        String podName = "tomcat8-new";
//
//
//        Copy copy = new Copy();
//        copy.
//        InputStream dataStream = copy.copyFileFromPod(namespace, podName, "/etc/file/java");
//        Streams.copy(dataStream, System.out,true);
//
//        copy.copyDirectoryFromPod(namespace, podName, null, "/file", Paths.get("/tmp/etc"));
//
//        System.out.println("Done!");
//
//    }


    /**
     * 创建命名空间  创建namespace
     * @param api
     */
    public static void createNamespace(CoreV1Api api){
        V1Namespace body = new V1Namespace();
        Boolean includeUninitialized =null;
        String pretty = null;
        String dryRun = null;
        body.setApiVersion("v1");
        body.setKind("Namespace");
        V1ObjectMeta metadata = new V1ObjectMeta();
        metadata.setName("compile-test");
        Map<String,String> labelMap = new HashMap<>();
        labelMap.put("app","compile");
        metadata.setLabels(labelMap);
        body.setMetadata(metadata);
        try{
            V1Namespace v1Namespace = api.createNamespace(body,includeUninitialized,pretty,dryRun);
            System.out.println("创建空间"+ JSONObject.toJSONString(v1Namespace));
        }catch (ApiException e){
            log.error("Exception when calling CoreV1Api#createNamespace");
            log.error("Status code: {}", e.getCode());
            log.error("Reason: {}", e.getResponseBody());
            log.error("Response headers: {}", e.getResponseHeaders());
        }
    }


    /**
     * 发布应用  创建Deployment
     * @param api
     */
    public static void createDeployment(AppsV1Api api,String namespace){
        try {
            V1Deployment body = new V1Deployment();
            body.apiVersion("apps/v1");
            body.setKind("Deployment");
            V1ObjectMeta metadata = new V1ObjectMeta();
            //metadata.setNamespace(namespace);
            //创建标签
            Map<String,String> labelsMap = new HashMap<>();
            labelsMap.put("app","java");
            metadata.setLabels(labelsMap);
            //创建名称
            metadata.setName("java-17");
            body.setMetadata(metadata);
            //创建spec
            V1DeploymentSpec spec = new V1DeploymentSpec();
            //数量
            spec.setReplicas(1);
            V1LabelSelector selector = new V1LabelSelector();
            Map<String,String> matchLabelsMap = new HashMap<>();
            matchLabelsMap.put("app","java");
            selector.setMatchLabels(matchLabelsMap);
            spec.setSelector(selector);

            V1PodTemplateSpec template = new V1PodTemplateSpec();
            V1ObjectMeta v1ObjectMeta = new V1ObjectMeta();
            Map<String,String> templLableMap = new HashMap<>();
            templLableMap.put("app","java");
            v1ObjectMeta.setLabels(templLableMap);

            V1PodSpec v1PodSpec = new V1PodSpec();
            List<V1Container> containers = new ArrayList<>();
            V1Container v1Container = new V1Container();
            v1Container.setName("java-container");
            v1Container.setImage("dquintela/openjdk-8-jdk-alpine");
            v1Container.setImagePullPolicy("IfNotPresent");
            //设置脚本
            List<String> commands = new ArrayList<>();
//            commands.add("/bin/sh");
//            commands.add("sh");
            commands.add("sh");
            commands.add("-c");
//            commands.add("javac HelloWorld.java");
//            commands.add("java HelloWorld");
            v1Container.setCommand(commands);
            List<String> args = new ArrayList<>();
            args.add("cd /write_dir&&javac HelloWorld.java&&java HelloWorld;sleep 3600");
//            args.add("java /write_dir/HelloWorld");
            v1Container.setArgs(args);
            //容器内挂载的路径
            V1VolumeMount volumeMount = new V1VolumeMount();
            volumeMount.setMountPath("/write_dir");
            volumeMount.setName("filedata");
            List<V1VolumeMount> mountList = new ArrayList<>();
            mountList.add(volumeMount);
            v1Container.setVolumeMounts(mountList);
            V1Volume v1Volume = new V1Volume();
            V1HostPathVolumeSource v1HostPathVolumeSource = new V1HostPathVolumeSource();
            v1HostPathVolumeSource.setPath("/files/k8s/pro-file");
            v1Volume.setHostPath(v1HostPathVolumeSource);
            v1Volume.setName("filedata");
            List<V1Volume> v1Volumes =new ArrayList<>();
            v1Volumes.add(v1Volume);
            v1PodSpec.setVolumes(v1Volumes);
            v1PodSpec.setNodeName("k8s-node1");
//            List<V1ContainerPort> ports = new ArrayList<>();
//            V1ContainerPort v1ContainerPort = new V1ContainerPort();
//            v1ContainerPort.setContainerPort(8081);
//            ports.add(v1ContainerPort);
//            v1Container.setPorts(ports);
            containers.add(v1Container);
            v1PodSpec.setContainers(containers);


            template.setMetadata(v1ObjectMeta);
            template.setSpec(v1PodSpec);
            spec.setTemplate(template);
            body.setSpec(spec);

            System.out.println(JSONObject.toJSONString(body));
            V1Deployment result = api.createNamespacedDeployment(namespace, body, null, null, null);


            System.out.println("发布应用"+result);

        } catch (ApiException e) {

            log.error("Exception when calling AppsV1Api#createNamespacedDeployment");
            log.error("Status code: {}", e.getCode());
            log.error("Reason: {}", e.getResponseBody());
            log.error("Response headers: {}", e.getResponseHeaders());
            e.printStackTrace();
        }
    }

    public static void addPod(AppsV1Api api,String namespace){

    }


    /**
     * 创建service
     * @param api
     * @param namespace
     */
    public static void createService(CoreV1Api api,String namespace){
        V1Service body = new V1Service();
        body.setApiVersion("v1");
        body.setKind("Service");

        V1ObjectMeta metadata = new V1ObjectMeta();
        metadata.setName("tomcat8");
        metadata.setNamespace(namespace);
        body.setMetadata(metadata);
        Map<String,String> labelMap = new HashMap<>();
        labelMap.put("app","tomcat8");
        metadata.setLabels(labelMap);
        body.setMetadata(metadata);

        V1ServiceSpec spec = new V1ServiceSpec();
        spec.setType("NodePort");
        List<V1ServicePort> v1ServicePortList = new ArrayList<>();
        V1ServicePort v1ServicePort = new V1ServicePort();
        v1ServicePort.setPort(80);
        v1ServicePort.setProtocol("TCP");
        v1ServicePort.setTargetPort(new IntOrString(8080));
        v1ServicePortList.add(v1ServicePort);
        spec.setPorts(v1ServicePortList);

        Map<String,String> selectorMap = new HashMap<>();
        selectorMap.put("app","tomcat8");
        spec.setSelector(selectorMap);
        spec.setType("NodePort");
        body.setSpec(spec);
        try{
            V1Service v1Service= api.createNamespacedService(namespace,body,null,null,null);
            System.out.println(JSONObject.toJSONString(v1Service));
        }catch (ApiException e){
            log.error("Exception when calling AppsV1Api#createNamespacedDeployment");
            log.error("Status code: {}", e.getCode());
            log.error("Reason: {}", e.getResponseBody());
            log.error("Response headers: {}", e.getResponseHeaders());
            e.printStackTrace();
        }
    }



    /**
     * 升级服务 ,将镜像升级 ，这里将镜像从ccbtest:latest换成了v2
     * @param api
     */
    public static void applyDeployment(AppsV1Api api,String namespace){
        try {
            V1Deployment body = new V1Deployment();
            body.apiVersion("apps/v1");
            body.setKind("Deployment");
            V1ObjectMeta metadata = new V1ObjectMeta();
            //metadata.setNamespace(namespace);
            metadata.setName("ccbtest");
            Map<String,String> labelsMap = new HashMap<>();
            labelsMap.put("app","ccbtest");
            metadata.setLabels(labelsMap);
            body.setMetadata(metadata);
            V1DeploymentSpec spec = new V1DeploymentSpec();
            spec.setReplicas(1);
            V1LabelSelector selector = new V1LabelSelector();
            Map<String,String> matchLabelsMap = new HashMap<>();
            matchLabelsMap.put("app","ccbtest");
            selector.setMatchLabels(matchLabelsMap);
            spec.setSelector(selector);

            V1PodTemplateSpec template = new V1PodTemplateSpec();
            V1ObjectMeta v1ObjectMeta = new V1ObjectMeta();
            Map<String,String> templLableMap = new HashMap<>();
            templLableMap.put("app","ccbtest");
            v1ObjectMeta.setLabels(templLableMap);

            V1PodSpec v1PodSpec = new V1PodSpec();
            List<V1Container> containers = new ArrayList<>();
            V1Container v1Container = new V1Container();
            v1Container.setName("ccbtest");
            v1Container.setImage("127.0.0.1:80/library/ccbtest:v2");
            v1Container.setImagePullPolicy("IfNotPresent");
            List<V1ContainerPort> ports = new ArrayList<>();
            V1ContainerPort v1ContainerPort = new V1ContainerPort();
            v1ContainerPort.setContainerPort(8081);
            ports.add(v1ContainerPort);
            v1Container.setPorts(ports);
            containers.add(v1Container);
            v1PodSpec.setContainers(containers);

            template.setMetadata(v1ObjectMeta);
            template.setSpec(v1PodSpec);
            spec.setTemplate(template);
            body.setSpec(spec);

            String name = "ccbtest";
            System.out.println(JSONObject.toJSONString(body));
            V1Deployment result = api.replaceNamespacedDeployment(name,namespace, body, null, null);


            System.out.println("发布应用"+JSONObject.toJSONString(result));

        } catch (ApiException e) {

            log.error("Exception when calling AppsV1Api#createNamespacedDeployment");
            log.error("Status code: {}", e.getCode());
            log.error("Reason: {}", e.getResponseBody());
            log.error("Response headers: {}", e.getResponseHeaders());
            e.printStackTrace();
        }
    }

    /**
     * 查询节点
     * @param api
     */
    public static void getPodList(CoreV1Api api){
        try{
            //打印所有的pod
            V1PodList list = api.listNamespacedPod("default", null, null, null, null, null, null, null, null,null);

            for (V1Pod item : list.getItems()) {
                System.out.println(JSONObject.toJSONString(item.getMetadata().getName()));
            }

            AppsV1Api appsV1Api = new AppsV1Api();
            V1DeploymentList v1DeploymentList = appsV1Api.listDeploymentForAllNamespaces(null, null, null, null, null, null, null, null,null);
            List<V1Deployment> v1DeploymentListItems = v1DeploymentList.getItems();
            for(V1Deployment v1Deployment:v1DeploymentListItems){
                System.out.println(JSONObject.toJSONString(v1Deployment.getMetadata().getName()));
            }
        }catch (ApiException e){
            e.printStackTrace();
        }

    }

}

```

## 获取pod

1. 通过label标签获取

   1. ```java
              V1PodList list = coreV1Api.listNamespacedPod("java-compile", null, null, null, null, "apps", null, null, null,null);
              for (V1Pod item : list.getItems()) {
                  System.out.println(item.getMetadata().getName());
              }
      ```

![image-20220618142207776](https://mynotepicbed.oss-cn-beijing.aliyuncs.com/img/image-20220618142207776.png)

1. 过遍历job获取
   1. 
