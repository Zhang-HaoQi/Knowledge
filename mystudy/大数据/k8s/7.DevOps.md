# DevOps

1. 凭证：
   1. dockerhub
   2. github 
   3. kubeconfig
   4. SONAr - cube

2. fork项目
   1. 修改jekins文件
3. test的时候，有-o，表示离线下载，







1. 修改代码

2. 编写dockerfile，构建成镜像

   ![image-20220725093438102](https://mynotepicbed.oss-cn-beijing.aliyuncs.com/img/image-20220725093438102.png)

3. 通过dockercompose进行编排redis等服务

   ![image-20220725093518078](https://mynotepicbed.oss-cn-beijing.aliyuncs.com/img/image-20220725093518078.png)

4. 编写webhook，项目发生变化后，会通知jekins
5. jekins进行



## jenkins

### k8s部署jenkins安装

1. `kubectl create namespace jenkins    `

2. 创建jenkins服务，暴露30000端口

   ```yaml
   apiVersion: apps/v1
   kind: Deployment
   metadata:
     name: jenkins-deployment
   spec:
     replicas: 1
     selector:
       matchLabels:
         app: jenkins
     template:
       metadata:
         labels:
           app: jenkins
       spec:
         containers:
         - name: jenkins
           image: jenkinsci/blueocean:latest
           ports:
           - containerPort: 8080
           volumeMounts:
           - name: jenkins-home
             mountPath: /var/jenkins_home
         volumes:
           - name: jenkins-home
             emptyDir: {}
   ---
   apiVersion: v1
   kind: Service
   metadata:
     name: jenkins
   spec:
     type: NodePort
     ports:
       - port: 8080
         targetPort: 8080
         nodePort: 30000
     selector:
       app: jenkins
   
   ```

​		kubectl apply -f jenkins.yaml -n jenkins

3. 镜像拉取失败

   ![image-20220725100022249](https://mynotepicbed.oss-cn-beijing.aliyuncs.com/img/image-20220725100022249.png)

   配置加速器：/etc/docker/daemon.json



### docker 安装

#### 1. 安装jenkins

1. docker pull jenkins/jenkins:lts-jdk11

2. docker run -p 8080:8080 -p 50000:50000 --restart=on-failure jenkins/jenkins:lts-jdk11

   ![image-20220725142803320](https://mynotepicbed.oss-cn-beijing.aliyuncs.com/img/image-20220725142803320.png)

3. 访问ip：8080，填写秘钥。

   ![image-20220725110915358](https://mynotepicbed.oss-cn-beijing.aliyuncs.com/img/image-20220725110915358.png)

   ![image-20220725111023445](https://mynotepicbed.oss-cn-beijing.aliyuncs.com/img/image-20220725111023445.png)

4. 安装推荐的插件
5. 设置用户   jenkins   train@jenkins

#### 2. 支持coding

最新版的jenkins已经不支持原来的coding插件，使用Generic Webhook trigger替代。

参考文章：[Jenkins使用Coding Webhook Plugin过时问题（个人小记） - 掘金 (juejin.cn)](https://juejin.cn/post/7050302249045590023)

#### 3. 配置jdk

1. 进入jenkins容器：docker exec -it containId bash

2. 执行：echo $JAVA_HOME

   ![image-20220725153015843](https://mynotepicbed.oss-cn-beijing.aliyuncs.com/img/image-20220725153015843.png)

3. 将jdk路径配置到全局

   ![image-20220725153256009](https://mynotepicbed.oss-cn-beijing.aliyuncs.com/img/image-20220725153256009.png)









### 宿主机部署jenkins

[(78条消息) Jenkins安装+Springboot项目完整部署流程（超详细）_我玩亚索我会 C的博客-CSDN博客_jenkins部署springboot项目](https://blog.csdn.net/qq_42785250/article/details/125152099)

参考：https://www.jb51.net/article/230962.htm#_label1

参考文章：https://blog.csdn.net/weixin_49343190/article/details/123611576?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~default-0-123611576-blog-125152099.pc_relevant_multi_platform_whitelistv1_exp2&spm=1001.2101.3001.4242.1&utm_relevant_index=3

访问端口：

#### 3. 安装jdk

1. 上传linux-jdk到宿主机

2. 解压文件：tar -zxvf  jar包名称

3. 配置环境变量

   ```yaml
   export JAVA_HOME=/files/jenkins/env/jdk1.8.0_181
   export CLASSPATH=.:$JAVA_HOME/lib/dt.:jar$JAVA_HOME/lib/tools.jar
   export PATH=$JAVA_HOME/bin:$PATH
   ```

4. source /etc/profile   重新执行刚修改的初始化文档
5. java --version  javac

#### 4. 安装Maven

1. 下载：maven[Maven – Download Apache Maven](https://maven.apache.org/download.cgi)![image-20220725144812409](https://mynotepicbed.oss-cn-beijing.aliyuncs.com/img/image-20220725144812409.png)



2. 解压文件：tar -zxvf  jar包名称

3. 配置环境变量

   ```java
   export MAVEN_HOME=/files/jenkins/env/apache-maven-3.8.6
   export PATH=$PATH:$MAVEN_HOME/bin
   ```

4. 修改apache-maven-3.8.6/conf/setting.xml文件，添加阿里镜像。

   ```java
   <mirrors>
      <mirror>
       <id>alimaven</id>
       <mirrorOf>central</mirrorOf>
       <name>aliyun maven</name>
       <url>http://maven.aliyun.com/nexus/content/repositories/central/</url>
     </mirror>
   </mirrors>
   ```

#### 5. 安装jenkis

**方式一：下载jar包，直接启动**

1. nohup java -jar jenkins.war --httpPort=8080 --prefix="/jenkins" > jenkins.log  2>&1 & 
2. 问题：修改端口的时候，会出现404

**方式二：下载压缩文件**

注意：使用这种方式，需要先安装好jdk

1. 下载文件：

   ```java
   命令切换到自己的下载目录
   直接用命令下载
       wget http://pkg.jenkins-ci.org/redhat-stable/jenkins-2.190.3-1.1.noarch.rpm
   下载直接安装
       rpm -ivh jenkins-2.190.3-1.1.noarch.rpm
   ```

2. 修改jenkins配置

   ```java
   vi /etc/sysconfig/jenkins
   修改端口如下：
   JENKINS_PORT="8081"
   ```

3. 配置jdk路径

   ```java
   打开该文件：vi /etc/init.d/jenkins 
   配置Jenkins里的JDK路径 /env/jdk1.8.0_181/bin
   ```

   ![image-20220726090108524](https://mynotepicbed.oss-cn-beijing.aliyuncs.com/img/image-20220726090108524.png)

4. 启动jenkins

   ```java
   执行 systemctl daemon-reload 命令重新加载配置文件
   执行 systemctl start jenkins 命令启动Jenkins
   执行 systemctl status jenkins.service 命令查看Jenkins服务的状态
   ```

   出现ACTIVE：running即可启动成功。

   ![image-20220725221507816](https://mynotepicbed.oss-cn-beijing.aliyuncs.com/img/image-20220725221507816.png)

   加载完毕后，出现这个页面

   ![image-20220726090328608](https://mynotepicbed.oss-cn-beijing.aliyuncs.com/img/image-20220726090328608.png)

   ![image-20220726090354721](https://mynotepicbed.oss-cn-beijing.aliyuncs.com/img/image-20220726090354721.png)

#### 10. 卸载jenkins

![image-20220726092321327](https://mynotepicbed.oss-cn-beijing.aliyuncs.com/img/image-20220726092321327.png)







# 参考文章

https://blog.csdn.net/m0_59430185/category_11642403.html







# 基于K8s构建Jenkins持续集成平台（部署流程）

https://blog.csdn.net/m0_59430185/article/details/123394853





# Docker+Jenkins+Gitee+Maven构建自动化部署

[(78条消息) Docker+Jenkins+Gitee+Maven构建自动化部署_熟透的蜗牛的博客-CSDN博客_docker gitee 自动化部署](https://blog.csdn.net/weixin_39555954/article/details/124416725?spm=1001.2101.3001.6650.2&utm_medium=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~default-2-124416725-blog-101221904.pc_relevant_aa_2&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~default-2-124416725-blog-101221904.pc_relevant_aa_2&utm_relevant_index=5)







# Coding

## 部署springboot

参考文章：[(80条消息) 使用Coding对项目进行自动化的部署_皮皮闪的博客-CSDN博客_coding自动化部署](https://blog.csdn.net/qq_45672446/article/details/119789919)

### 1. 上传代码到coding仓库

1. 创建springboot项目，编写接口

   ![image-20220727171605042](https://mynotepicbed.oss-cn-beijing.aliyuncs.com/img/image-20220727171605042.png)

2. 在根目录创建jenkins文件

   ![image-20220727173307363](https://mynotepicbed.oss-cn-beijing.aliyuncs.com/img/image-20220727173307363.png)

   ```yaml
   pipeline {
     agent any
     stages {
       stage('检出') {
         steps {
           checkout([
             $class: 'GitSCM',
             branches: [[name: env.GIT_BUILD_REF]],
             userRemoteConfigs: [[
               url: env.GIT_REPO_URL,
               credentialsId: env.CREDENTIALS_ID
             ]]])
           }
         }
         stage('构建${packageType}') {
           steps {
             echo '构建中...'
             sh 'mvn clean package -Ptest -DskipTests'
             echo '构建完成.'
           }
         }
         stage('收集构建物') {
           steps {
             archiveArtifacts 'target/*.jar'
           }
         }
         stage('部署到服务器') {
           steps {
             script {
               def remote = [:]
               remote.name = 'tiger-server'
               remote.host = '服务器地址'                 # 服务器地址需要配置
               remote.user = 'root'
               remote.allowAnyHosts = true
               withCredentials([sshUserPrivateKey(credentialsId: "凭据id", keyFileVariable: 'id_rsa')]) {    # 凭据id需要配置
                 remote.identityFile = id_rsa
                 stage("推送文件到远程服务器") {
                   sshPut remote: remote, from: 'target/jar包名称', into: '/opt/zqh/'    # jar包名称需要配置
                 }
                 stage("重启服务") {                                  # 执行部署脚本
                   $result = sshCommand remote: remote, command: 'sh /opt/zqh/spring-start.sh restart /opt/zqh/jar包名称 8080'                                                                     # jar包名称需要配置
                   if($result.indexOf("jar包启动超时-1") > -1){
                     echo 'jar包启动超时-1'
                     set -e
                   }
                 }
               }
             }
   
           }
         }
       }
     }
   
   ```

3. 服务器地址，凭据id，jar包名称需要换成自己本地的。

   凭据获取方式：

   ![image-20220727173154026](https://mynotepicbed.oss-cn-beijing.aliyuncs.com/img/image-20220727173154026.png)

   ![image-20220727173231094](https://mynotepicbed.oss-cn-beijing.aliyuncs.com/img/image-20220727173231094.png)

   

主要内容

![image-20220727171639022](https://mynotepicbed.oss-cn-beijing.aliyuncs.com/img/image-20220727171639022.png)

### 2. 创建构建计划

![image-20220727171709927](C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20220727171709927.png)

1. 仓库为coding，2——4为默认

![image-20220727171946944](https://mynotepicbed.oss-cn-beijing.aliyuncs.com/img/image-20220727171946944.png)

2. 创建制品库

   ![image-20220727172034790](https://mynotepicbed.oss-cn-beijing.aliyuncs.com/img/image-20220727172034790.png)

3. 选择远程服务器

   ![image-20220727172104695](https://mynotepicbed.oss-cn-beijing.aliyuncs.com/img/image-20220727172104695.png)

4. 配置凭据，录入新的凭据，并把凭据内容复制到服务器的/root/.ssh/authorized_keys文件中

   ![image-20220727172143159](https://mynotepicbed.oss-cn-beijing.aliyuncs.com/img/image-20220727172143159.png)

5. 在服务器的/opt/zqh/spring-start.sh上传部署脚本文件 spring-start.sh

   ```shell
   #!/bin/bash
   JVM_OPEION='-Xms246m -Xmx246m'
   JAR_PID='无效'
   # jar包所在的目录
   JAR_HOME='/opt/zqh/'
   # JDK的目录
   JAVA_HOME='/env/jdk1.8.0_181/bin/java'
   JAR_ACTIVE='dev'
   # 检查次数
   EXAMINE_TIME=13
   #使用说明，用来提示输入参数
   usage() {
     echo "Usage: sh spring-startup.sh [start|stop|restart|status]"
     exit 1
   }
   
   #检查程序是否在运行
   is_exist() {
     orderStr="ps -ef | grep $1 | grep -v "\$0" | grep -v "grep" | awk '{print \$2}'"
     echo "检查命令: $orderStr"
     pid=$(eval $orderStr)
     #如果存在返回1，不存在返回0
     if [ -n "${pid}" ]; then
       JAR_PID=$pid
       echo "pid=${pid}"
       echo "JAR_PID=${JAR_PID}"
       return 1
     else
       return 0
     fi
   }
   
   #启动方法
   start() {
     is_exist $1
     if [ $? -eq "1" ]; then
       echo "$1 is already running. pid=${JAR_PID} ."
     else
       echo "--------$1 开始启动--------"
       jarname=$1
       filename=${jarname##*/}
       name=${filename%.*}
       logName=${name%_*}_$2.log
       javaShellStr="nohup /env/jdk1.8.0_181/bin/java -jar /opt/zqh/devops-test-0.0.1-SNAPSHOT.jar --spring.profiles.active=dev > /opt/zqh/nohup.log 2>&1 &"         # 启动脚本   这里并没有让动态的指定环境，端口，以及jar包名称
       echo "启动命令: $javaShellStr"
       eval $javaShellStr
       # 检查端口
       portStr="lsof -i:$2 | grep "LISTEN" | awk '{print \$2}'"
       echo "端口检查：$portStr"
       jarPort=$(eval $portStr)
       # 计时器
       stime=0
       # 判断端口是否为0，次数是否小于7
       until [[ -n "$jarPort" ]]; do
         sleep 3s
         tail -n 5 $JAR_HOME/logs/$logName
         stime=$((stime + 1))
         jarPort=$(eval $portStr)
         echo "启动检查第$stime次"
         # 超时判断 大于13，打印 -1 结束当前操作
         if [ $stime -ge $EXAMINE_TIME ]; then break; fi
       done
       if [ $stime -ge $EXAMINE_TIME ]; then
         echo "jar包启动超时-1"
         exit; fi
       echo "$1 start success"
     fi
   }
   
   #停止方法
   stopPort() {
     portStr="netstat -nlp | grep :$1 | awk '{print \$7}' | awk -F\"/\" '{ print \$1 }'"
     echo "启动命令: $portStr"
     JAR_PID=$(eval $portStr)
     if [ -n "$JAR_PID" ]; then
       kill -9 $JAR_PID
       JAR_PID=$(eval $portStr)
       if [ -n "$JAR_PID" ]; then
         echo "$1 is running. Pid is ${JAR_PID}"
       else
         echo "$1 is stop."
       fi
     else
       echo "$1 is not running"
     fi
   }
   
   #停止方法
   stop() {
     is_exist $1
     if [ $? -eq "1" ]; then
       while [[ -n "$JAR_PID" && "$JAR_PID" -ne "0" ]]; do
         echo "$1 is already running. pid=${JAR_PID} ."
         kill -9 $JAR_PID
         sleep 1s
         is_exist $1
         JAR_PID=$?
       done
       echo "$1 is kill"
     else
       echo "$1 is not running"
     fi
   }
   
   #输出运行状态
   status() {
     is_exist $1
     if [ $? -eq "1" ]; then
       echo "$1 is running. Pid is ${JAR_PID}"
     else
       echo "$1 is NOT running."
     fi
   }
   
   #重启
   restart() {
     stop $1
     start $1 $2
   }
   
   #根据输入参数，选择执行对应方法，不输入则执行使用说明
   case "$1" in
   "start")
     start $2 $3
     ;;
   "stop")
     stop $2
     ;;
   "status")
     status $2
     ;;
   "restart")
     restart $2 $3
     ;;
   *)
     usage
     ;;
   esac
   
   
   
   ```

6. 取消勾选

   ![](https://mynotepicbed.oss-cn-beijing.aliyuncs.com/img/image-20220727175001014.png)

7. 设置

   ![image-20220727175049661](https://mynotepicbed.oss-cn-beijing.aliyuncs.com/img/image-20220727175049661.png)

   ![image-20220727175101415](https://mynotepicbed.oss-cn-beijing.aliyuncs.com/img/image-20220727175101415.png)

   表示使用我们自己的jenkins文件

### 3. 执行构建

点击立即构建，即可完成构建

![image-20220727175213116](https://mynotepicbed.oss-cn-beijing.aliyuncs.com/img/image-20220727175213116.png)

![image-20220727175227337](https://mynotepicbed.oss-cn-beijing.aliyuncs.com/img/image-20220727175227337.png)