# Kubephere安装

## 简介

## 安装

官方网站：[在 Kubernetes 上最小化安装 KubeSphere](https://kubesphere.com.cn/docs/quick-start/minimal-kubesphere-on-k8s/)







##  安装NFS

### 安装NFS服务器

注意：指定一台机器，我选择了master

1. 安装NFS服务器应用：yum install -y nfs-utils rpcbind

2. 创建NFS共享目录：mkdir -p /data/k8snfs

3. 编辑NFS配置文件：vim /etc/exports

   ```shell
   /data/k8snfs
   *(rw,sync,insecure,no_subtree_check,no_root_squash)
   ```

   第一个参数是NFS共享目录的路径；

   第二个参数是允许共享目录的 网段，这里设置的是本书中的Kubernetes集群机器网段，也可以设置 为“*”以表示不限制。

   最后小括号中的参数为权限设置，rw表示允 许读写访问，sync表示所有数据在请求时写入共享目录，insecure 表示NFS通过1024以上的端口进行发送，no_root_squash表示root 用户对根目录具有完全的管理访问权限，no_subtree_check表示 不检查父目录的权限。

4. 重启服务：

   ```shell
   service rpcbind restart
   service nfs restart
   ```

   ![image-20220625123648535](https://mynotepicbed.oss-cn-beijing.aliyuncs.com/img/image-20220625123648535.png)

5. 检查服务器端是否正常加载 了/etc/exports的配置

   成功：![image-20220625123732776](https://mynotepicbed.oss-cn-beijing.aliyuncs.com/img/image-20220625123732776.png)

6. 注意：如果使用云服务器，需要开放一下端口，否则客户端连接不上。使用：rpcinfo -p 查看需要开放的端口。注意有tcp和udp

   ![image-20220625134223724](https://mynotepicbed.oss-cn-beijing.aliyuncs.com/img/image-20220625134223724.png)

### 安装NFS客户端

**注意：每台需要使用NFS的Node都需要安装NFS**

1. 安装客户端：yum install -y nfs-utils

2. 检查是否能访问远端的NFS服务器：sudo showmount -e {NFS服务器IP地址}

   ![image-20220625134401984](https://mynotepicbed.oss-cn-beijing.aliyuncs.com/img/image-20220625134401984.png)

   如果出现clnt_create: RPC: Port mapper failure - Timed out，使用云服务的话大概率是接口没开放。

### 使用NFS

安装完成后可以使用NFS作为存储卷。pod配置后，NFS中的数据可永久保存且可以被多个pod共享。

**使用nfs**

1. 创建一个exampledeployfornfs.yml

   ```yaml
   apiVersion: apps/v1
   kind: Deployment
   metadata:
     name: exampledeployfornfs
   spec:
     replicas: 2
     selector:
       matchLabels:
         example: examplefornfs
     template:
       metadata:
         labels:
           example: examplefornfs
       spec:
         containers:
         - name: containerfornfs
           image: busybox
           imagePullPolicy: IfNotPresent
           command: ['sh', '-c']
           args: ['echo "The host is $(hostname)" >> /dir/data; sleep 3600']
           volumeMounts:
           - name: nfsdata
             mountPath: /dir
         volumes:
         - name: nfsdata
           nfs:
             path: /data/k8snfs
             server: xx.xx.236.113
   ```

2. 解释：

   ![image-20220625140232546](https://mynotepicbed.oss-cn-beijing.aliyuncs.com/img/image-20220625140232546.png)

   1. args: ['echo "The host is $(hostname)" >> /dir/data; sleep 3600']

      创建的名为containerfornfs的容器用于向存储卷写入数据，**容器内的存储卷映射地址为/dir**，**它引用的存储卷为nfsdata。**容 器启动后会以追加方式（使用echo ...>>...命令）向/dir/data 文件写入文本，这段代码中使用$(hostname)环境变量获取主机名 称，对于Pod中的容器，获取到的是Pod名称。因为Deployment控制器 拥有多个Pod，所以通过这种方式，在同一个文件下会由多个Pod写入多行信息。

   2. 创建的存储卷名称为nfsdata，这个名称会被容器设置中的 volumeMounts所引用

   3. server和path属性分别对应之前在安装时配置的NFS机器IP地址与共享目录

3. 查看结果：

   1. kubectl get pod -o wide![image-20220625140409888](https://mynotepicbed.oss-cn-beijing.aliyuncs.com/img/image-20220625140409888.png)
   2. 分别进入容器查看
      1. kubectl exec -it podname /bin/sh
      2. ![image-20220625140638925](https://mynotepicbed.oss-cn-beijing.aliyuncs.com/img/image-20220625140638925.png)
      3. 由Deployment控制器生成的 两个Pod都已经成功地将信息写入同一个存储卷的同一个文件中。
   3. **不管哪个Pod，它们都直接引用NFS服务器上的文件，在所有 的编辑操作中也都直接处理NFS服务器上的文件。**

### 问题

网络存储卷使用的是不同于Kubernetes的额外系统，因此从 使用角度来说，网络存储卷存在两个问题。

1. 存储卷数据清理问题，需要人工清理。 
2. 在Pod模板中需要配置所使用存储的细节参数，于是与所使用的存 储方案产生高度耦合。若基础设施和应用配置之间没有分离，则不利于维护。

