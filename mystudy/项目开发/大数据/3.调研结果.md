# 在线编程调研

## 总体流程：

1. 前端提交代码
   1. 提交文本或者文件夹
2. 后端生成文件并上传到云存储
3. 将要执行的任务入队列
4. 使用k8s的job控制器生成一次性pod
   1. pod的最大生命周期为XXX秒
   2. 最大内存限制
   3. cpu限制
   4. 挂载云存储
   5. pod启动的时候回调，更新代码执行状态：运行中
   6. pod启动完成后，直接进行编译运行代码，代码结果写入日志文件中
   7. pod关闭时回调，更新代码执行状态：执行完成/关闭错误
   8. 读取日志文件，获取运行结果
5. 删除job控制器
6. 运行结果返回给前端

## **job配置文件**

```yaml
apiVersion: batch/v1
kind: Job
metadata:     # job配置
  name: job01 # 名称
  labels:     # 标签
    app: job01
  namespace: default # 命名空间
spec:  # job运行配置
#  ttlSecondsAfterFinished: 30 # 容器所有任务运行完30s后删除pod
  activeDeadlineSeconds: 100 # 容器最大的执行时间，超过这个时间后会自动删除job（如果是到了这个时间，容器关停，Job 的 Status 将变为 type:Failed 、 reason: DeadlineExceeded）。
#  backoffLimit: 6 # job启动失败后，会重新启动pod（此处重新启动指新建），7次（一次最开始创建，六次重启）之后，则不再重建
  template: # pod模板
    metadata: # pod配置
      name: job01 # pod名称
      labels: # pod标签
        job01: job01
    spec:  # pod的运行配置
      nodeName: k8s-node1 # 运行节点：后续可以取消
      restartPolicy: Never  # 重启策略：never 不重启
      containers:  # 容器配置
      - name: java-env # 容器名称
        image: dquintela/openjdk-8-jdk-alpine # 容器镜像
        imagePullPolicy: IfNotPresent # 镜像拉取策略，不存在即拉取
        command: ['sh', '-c'] # 容器创建时，执行脚本（注意：是容器创建的时候）
        args: ['cd /write_dir;javac HelloWorld.java;java HelloWorld;sleep 30'] # 进入相应文件夹并执行结果
        lifecycle: # 声明周期
          postStart: # 容器创建时候的回调
            httpGet:
             host: 192.168.58.3
             path: /api/code/test?podName=zhansgan
             port: 8080
             scheme: HTTP
          preStop: # 容器结束时候的回调
            httpGet:
             host: 192.168.58.3
             path: /api/code/test?podName=zhansgan
             port: 8080
             scheme: HTTP
        volumeMounts: # 容器挂载的目录
        - name: filedata
          mountPath: /write_dir
        resources: # 容器资源配置
            limits: # 最大的cpu和内存
              cpu: "1" # 设置
              memory: "100Mi"
            requests: # 容器至少满足cpu和内存
              cpu: "200m"
              memory: "50Mi"
      volumes: # 挂载的宿主机路径
        - name: filedata
          hostPath:
            path: /files/k8s/pro-file
```

## **配置Java Api**

```java
        
    
       <dependency>
            <groupId>io.kubernetes</groupId>
            <artifactId>client-java</artifactId>
            <version>9.0.2</version>
        </dependency>
            
            
                <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <version>1.18.0</version>
        </dependency>

        <!-- https://mvnrepository.com/artifact/org.slf4j/slf4j-api -->
        <dependency>
            <groupId>org.slf4j</groupId>
            <artifactId>slf4j-api</artifactId>
            <version>1.7.25</version>
        </dependency>

        <!-- https://mvnrepository.com/artifact/ch.qos.logback/logback-classic -->
        <dependency>
            <groupId>ch.qos.logback</groupId>
            <artifactId>logback-classic</artifactId>
            <version>1.2.3</version>
        </dependency>

        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>fastjson</artifactId>
            <version>1.2.49</version>
        </dependency>
```

## 注入bean

主节点获取config文件，放到类路径下，用于链接k8s

![image-20220621090739578](https://mynotepicbed.oss-cn-beijing.aliyuncs.com/img/image-20220621090739578.png)

![image-20220621090758225](https://mynotepicbed.oss-cn-beijing.aliyuncs.com/img/image-20220621090758225.png)

```java
@org.springframework.context.annotation.Configuration
public class K8sConfig {


    @Bean
    public ApiClient initClient() throws IOException {
        String kubeConfigPath = "classpath:config";
//        Reader rd =new FileReader(kubeConfigPath);
        //加载k8s,config
        ApiClient client =
                ClientBuilder.kubeconfig(KubeConfig.loadKubeConfig(new FileReader(ResourceUtils.getFile(kubeConfigPath)))).build();
        //将加载config的client设置为默认的client
        Configuration.setDefaultApiClient(client);
        return client;
    }
}
```

## 创建job

job控制器，用于执行一次性任务

```java
    public static void createJobPod(String filePath,String namespace) throws IOException, ApiException {
        BatchV1Api batchV1Api = new BatchV1Api();
        //加载配置文件
        File file = ResourceUtils.getFile(filePath);

        //对象映射
        V1Job v1Job = (V1Job) Yaml.load(file);
//        BatchV1Api batchV1Api = new BatchV1Api();
        V1Job job = batchV1Api.createNamespacedJob(namespace, v1Job, null, null, null);
        log.info("V1Job执行完成的格式：{}", Yaml.dump(job));
    }
```

## 获取job名称和状态

通过label进行pod的筛选，注意：pod配置的名称和生成的名称不一样，通过给不同的pod设置不同的label，通过label进行筛选，原则上筛选下来只会有一个pod

```java
 //获取pod名称
    public static String getPodRealName(String namespace, String label) throws ApiException {
        CoreV1Api coreV1Api = new CoreV1Api();
        V1PodList list = coreV1Api.listNamespacedPod(namespace, null, null, null, null, label, null, null, null, null);
        if (list != null) {
            List<V1Pod> items = list.getItems();
            if (items != null && items.size() != 0) {
                //获取pod名称
                V1Pod pod = items.get(0);
                String podName = pod.getMetadata().getName();
                //获取pod状态
                V1PodStatus status = pod.getStatus();
                System.out.println("podStatus:" + status);
                //获取容器
                List<V1Container> containers = pod.getSpec().getContainers();
                if (containers!=null&&containers.size()!=0){
                    V1Container v1Container = containers.get(0);
                }
                return pod.getMetadata().getName();
            }
        }
        return "";
    }
```

## 创建命名空间

```java
/**
     * 创建命名空间  创建namespace
     */
    public static void createNamespace() {
        CoreV1Api api = new CoreV1Api();
        V1Namespace body = new V1Namespace();
        String pretty = null;
        String dryRun = null;
        body.setApiVersion("v1");
        body.setKind("Namespace");
        V1ObjectMeta metadata = new V1ObjectMeta();
        metadata.setName("compile-test");
        Map<String, String> labelMap = new HashMap<>();
        labelMap.put("app", "compile");
        metadata.setLabels(labelMap);
        body.setMetadata(metadata);
        try {
            V1Namespace v1Namespace = api.createNamespace(body, null, pretty, dryRun);
            System.out.println("创建空间" + JSONObject.toJSONString(v1Namespace));
        } catch (ApiException e) {
            log.error("Exception when calling CoreV1Api#createNamespace");
            log.error("Status code: {}", e.getCode());
            log.error("Reason: {}", e.getResponseBody());
            log.error("Response headers: {}", e.getResponseHeaders());
        }
    }
```

## 详细api查看官方文档

[java/WatchExample.java at master · kubernetes-client/java (github.com)](https://github.com/kubernetes-client/java/blob/master/examples/examples-release-15/src/main/java/io/kubernetes/client/examples/WatchExample.java)

## 其他

